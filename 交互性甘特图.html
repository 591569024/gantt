<!DOCTYPE HTML>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" type="text/css" href="css/font-awesome.min.css"/>
<style>#container, #buttonGroup {
	max-width: 1200px;
	min-width: 320px;
	margin: 1em auto;
}
.hidden {
	display: none;
}
.main-container button {
	font-size: 12px;
	border-radius: 2px;
	border: 0;
	background-color: #ddd;
	padding: 13px 18px;
}
.main-container button[disabled] {
	color: silver;
}
.button-row button {
	display: inline-block;
	margin: 0;
}
.overlay {
	position: fixed;
	top: 0;
	bottom: 0;
	left: 0;
	right: 0;
	background: rgba(0, 0, 0, 0.3);
	transition: opacity 500ms;
}
.popup {
	margin: 70px auto;
	padding: 20px;
	background: #fff;
	border-radius: 5px;
	width: 300px;
	position: relative;
}
.popup input, .popup select {
	width: 100%;
	margin: 5px 0 15px;
}
.popup button {
	float: right;
	margin-left: 0.2em;
}
.popup .clear {
	height: 50px;
}
.popup input[type=text], .popup select {
	height: 2em;
	font-size: 16px;
}
</style>	<script src="js/highcharts-gantt.js"></script>
	<script src="js/draggable-points.js"></script>
	<script src="js/exporting.js"></script>
</head>
<body>

	<div class="main-container">
	<div id="container"></div>
	<div id="buttonGroup" class="button-row">
		<button id="btnShowDialog">
			<i class="fa fa-plus"></i>
			Add task
		</button>
		<button id="btnRemoveSelected" disabled="disabled">
			<i class="fa fa-remove"></i>
			Remove selected
		</button>
	</div>
	<div id="addTaskDialog" class="hidden overlay">
		<div class="popup">
			<h3>Add task</h3>
			<label>Task name <input id="inputName" type="text" /></label>
			<label>Department
				<select id="selectDepartment">
					<option value="0">Tech</option>
					<option value="1">Marketing</option>
					<option value="2">Sales</option>
				</select>
			</label>
			<label>Dependency
				<select id="selectDependency">
					<!-- Filled in by Javascript -->
				</select>
			</label>
			<label>
				Milestone
				<input id="chkMilestone" type="checkbox" />
			</label>
			<div class="button-row">
				<button id="btnAddTask">Add</button>
				<button id="btnCancelAddTask">Cancel</button>
			</div>
			<div class="clear"></div>
		</div>
	</div>
</div>

	<script>
	/*
    Simple demo showing some interactivity options of Highcharts Gantt. More
    custom behavior can be added using event handlers and API calls. See
    http://api.highcharts.com/gantt.
*/
var today = new Date(),
	hour = 1000 * 60 * 60,
	each = Highcharts.each,
	reduce = Highcharts.reduce,
	btnShowDialog = document.getElementById('btnShowDialog'),
	btnRemoveTask = document.getElementById('btnRemoveSelected'),
	btnAddTask = document.getElementById('btnAddTask'),
	btnCancelAddTask = document.getElementById('btnCancelAddTask'),
	addTaskDialog = document.getElementById('addTaskDialog'),
	inputName = document.getElementById('inputName'),
	selectDepartment = document.getElementById('selectDepartment'),
	selectDependency = document.getElementById('selectDependency'),
	chkMilestone = document.getElementById('chkMilestone'),
	isAddingTask = false;
// Set to 00:00:00:000 today
today.setUTCHours(0);
today.setUTCMinutes(0);
today.setUTCSeconds(0);
today.setUTCMilliseconds(0);
today = today.getTime();
// Update disabled status of the remove button, depending on whether or not we
// have any selected points.
function updateRemoveButtonStatus() {
	var chart = this.series.chart;
	// Run in a timeout to allow the select to update
	setTimeout(function () {
		btnRemoveTask.disabled = !chart.getSelectedPoints().length ||
			isAddingTask;
	}, 10);
}

function dealTime(points, childNodes, e, isBegin, current, end){
	if(childNodes.length)  {
		if  (isBegin) {
			childNodes.forEach(p =>{
				let diff = e.newPoint.end - p.start;
				// selfStart = Highcharts.dateFormat('%Y-%m-%d %H:%M', e.newPoint.start)
				// selfEnd = Highcharts.dateFormat('%Y-%m-%d %H:%M', e.newPoint.end)//%Y-%m-%d %H:%M:%S
				if(e.newPoint.end > p.start) {
					p.update({
						start: p.start + diff,
						end: p.end+ diff
					}, false);
					dealTime(points, childNodes, e, false, p, p.end)
					// childStart = Highcharts.dateFormat('%Y-%m-%d %H:%M', p.start + diff)
					// childEnd = Highcharts.dateFormat('%Y-%m-%d %H:%M', p.end+ diff)
				}
			})
		}
		else {
			let childNodes = [];
			points.forEach(p => {
				if (p.dependency === current.id) {
					childNodes.push(p)
				}
			});
			if (childNodes.length) {
				childNodes.forEach(p => {
					if (end > p.start) {
						p.update({
							start: end,
							end: end + (p.end - p.start)
						}, false);
						// childStart = Highcharts.dateFormat('%Y-%m-%d %H:%M', p.start + diff)
						// childEnd = Highcharts.dateFormat('%Y-%m-%d %H:%M', p.end+ diff)
						dealTime(points, childNodes, e, false, p, p.end)
					}
				})
			}

		}
	}

}

function dropmMethod1(points, e){
	let id = e.newPointId;
	if(id) {
		let childNodes = [];
		points.forEach(p => {
			if(p.dependency === id) {
				childNodes.push(p)
			}
		});
		dealTime(points, childNodes, e, true)

	}
}

function dropmMethod2(points, e) {
	let dependency = e.target.options.dependency;
	if (dependency) {
		let dependencyPoint = null;
		points.forEach(p => {
			if (p.id === dependency) {
				dependencyPoint = p;
			}
		});
		// selfStart = Highcharts.dateFormat('%Y-%m-%d %H:%M', e.newPoint.start)
		// selfEnd = Highcharts.dateFormat('%Y-%m-%d %H:%M', e.newPoint.end)//%Y-%m-%d %H:%M:%S
		if (dependencyPoint && e.newPoint.start < dependencyPoint.end) {
			let diff = dependencyPoint.end - e.newPoint.start;
			e.newPoint.start += diff;
			e.newPoint.end += diff;
			// fatherStart = Highcharts.dateFormat('%Y-%m-%d %H:%M', e.newPoint.start)
			// fatherEnd = Highcharts.dateFormat('%Y-%m-%d %H:%M', e.newPoint.end)//%Y-%m-%d %H:%M:%S
		}
	}
}

function updateDate(points){
	let myself = null;
	points.forEach(p => {
		if(p.id === e.newPointId) {
				myself = p
			}
		});

	alert(myself.y);
}

// Create the chart
var chart = Highcharts.ganttChart('container', {
	chart: {
		spacingLeft: 1
	},
	title: {
		text: 'Interactive Gantt Chart'
	},
	subtitle: {
		text: 'Drag and drop points to edit'
	},
	plotOptions: {
		series: {
			animation: false, // Do not animate dependency connectors
			dragDrop: {
				draggableX: true,
				draggableY: true,
				dragMinY: 0,
				dragMaxY: 2,
				dragPrecisionX: hour / 60 // Snap to 1 min
			},
			dataLabels: {
				enabled: true,
				format: '{point.name}',
				style: {
					cursor: 'default',
					pointerEvents: 'none'
				}
			},
			allowPointSelect: true,
			point: {
				events: {
					drag: function(e) {
						// console.log(e)
					},
					/**
					 *  拖拽限制：
					 *  1. 父节点拖动超过子节点开始时间时，子节点自动对齐父节点的结束时间
					 *  2. 叶子节点拖动开始时间小于父节点的结束时间时，子节点开始时间设置为父节点的结束时间
					 */
					drop: function(e) {
						// 1.
						dropmMethod1(this.series.points, e)
						// 2.
						dropmMethod2(this.series.points, e)

					}
				}
			}
		}
	},
	yAxis: {
		type: 'category',
		categories: ['Tech', 'Marketing', 'Sales'],
		min: 0,
		max: 2
	},
	xAxis: {
		currentDateIndicator: true
	},
	navigator: {
		enabled: true
	},
	scrollbar: {
		enabled: true
	},
	rangeSelector: {
		enabled: true,
	},
	tooltip: {
		xDateFormat: '%a %b %d, %H:%M'
	},
	series: [{
		name: 'Project 1',
		data: [{
			start: today + 1 * hour,
			end: today + hour * 9,
			name: 'Prototype',
			id: 'prototype',
			y: 0
		},  {
			start: today + hour * 10,
			end: today + hour * 30,
			name: 'Prototype done',
			dependency: 'prototype',
			id: 'proto_done',
			y: 0
		},{
			start: today + 40 * hour,
			end: today + hour * 70,
			name: 'test',
			id: 'test',
			dependency: 'proto_done',
			y: 2
		},  {
			start: today + hour * 80,
			end: today + hour * 100,
			name: 'test done',
			dependency: 'test',
			id: 'test_done',
			y: 1
		},  {
			start: today + hour * 78,
			end: today + hour * 90,
			name: 'test done1',
			dependency: 'test',
			id: 'test_done1',
			y: 2
		}]
	}]
});
</script>
</body>
</html>